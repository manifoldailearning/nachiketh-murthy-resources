---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CTA from '../../components/CTA.astro';
import { getAllVideos, getVideoBySlug, truncate } from '../../lib/videos';
import fs from 'node:fs/promises';
import path from 'node:path';
import { marked } from 'marked';

export function getStaticPaths() {
  return getAllVideos().map((v) => ({ params: { slug: v.slug } }));
}

const { slug } = Astro.params;
const video = slug ? getVideoBySlug(slug) : undefined;

const title = video ? `${video.title} — Manifold AI Learning` : 'Video Not Found — Manifold AI Learning';
const description = video
  ? truncate(video.description, 160)
  : truncate('This video could not be found. Return to the video resources home page.', 160);
const canonicalPath = `/videos/${slug ?? ''}/`;

const base = import.meta.env.BASE_URL;
const basePrefix = base === '/' ? '' : base.replace(/\/$/, '');
const homeHref = `${basePrefix}/`;
const resourceHref = (url: string) => (url.startsWith('/') ? `${basePrefix}${url}` : url);

let descriptionHtml: string | null = null;

if (video?.descriptionFile) {
  const rel = video.descriptionFile.replace(/^\/+/, ''); // resources/...
  const filePath = path.join(process.cwd(), 'public', rel);

  try {
    const md = await fs.readFile(filePath, 'utf8');
    const renderer = new marked.Renderer();
    renderer.link = (href, title, text) => {
      const safeHref = typeof href === 'string' ? href : '#';
      const titleAttr = title ? ` title="${title}"` : '';
      const label = typeof text === 'string' ? text : '';
      return `<a href="${safeHref}"${titleAttr} target="_blank" rel="noopener noreferrer">${label}</a>`;
    };
    const html = marked(md, { renderer }) as string;
    descriptionHtml = html;
  } catch {
    descriptionHtml = null;
  }
}
---

<BaseLayout title={title} description={description} canonicalPath={canonicalPath} ogType="article">
  {video ? (
    <article class="page">
      <header class="page__header">
        <h1 class="page__title">{video.title}</h1>
        <div class="meta">
          <time datetime={video.date}>{video.date}</time>
          <span class="meta__dot">•</span>
          <ul class="tags" aria-label="Tags">
            {video.tags.map((t) => (
              <li class="tag">{t}</li>
            ))}
          </ul>
        </div>
      </header>

      <section class="embed" aria-label="YouTube video">
        <iframe
          class="embed__frame"
          width="560"
          height="315"
          src={`https://www.youtube-nocookie.com/embed/${video.youtubeId}`}
          title={video.title}
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
          loading="lazy"
        />
      </section>

      {video.primaryCta && (
        <section class="primaryCta" aria-label="Primary call to action">
          <a
            class="primaryCta__button"
            href={video.primaryCta.url}
            target="_blank"
            rel="noopener noreferrer"
          >
            {video.primaryCta.label}
          </a>
        </section>
      )}

      {descriptionHtml ? (
        <section class="descRich" aria-label="Detailed description">
          <div class="descRich__inner" set:html={descriptionHtml} />
        </section>
      ) : (
        <section class="content">
          <p class="desc">{video.description}</p>
        </section>
      )}

      <section class="resources" aria-label="Resources">
        <h2 class="resources__title">Resources</h2>
        {video.resources?.length ? (
          <ul class="resources__list">
            {video.resources.map((r) => (
              <li class="resources__item">
                <a class="resources__link" href={resourceHref(r.url)}>
                  <span class="resources__label">{r.label}</span>
                  <span class="resources__type">{r.type}</span>
                </a>
              </li>
            ))}
          </ul>
        ) : (
          <p class="muted">No resources listed yet.</p>
        )}
      </section>

      <CTA variant="default" />
    </article>
  ) : (
    <section class="notfound" aria-label="Not found">
      <h1 class="notfound__title">Video not found</h1>
      <p class="notfound__desc">
        This page doesn’t exist (or the slug is wrong). Go back to the list and try again.
      </p>
      <a class="notfound__link" href={homeHref}>Back to all videos</a>
    </section>
  )}

  <style>
    .page {
      display: grid;
      gap: 1.25rem;
    }
    .page__title {
      margin: 0;
      font-size: clamp(1.5rem, 2.6vw, 2.1rem);
      letter-spacing: -0.02em;
      line-height: 1.15;
    }
    .meta {
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
      color: var(--muted);
    }
    .meta__dot {
      opacity: 0.75;
    }
    .tags {
      list-style: none;
      display: inline-flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0;
      margin: 0;
    }
    .tag {
      font-size: 0.8rem;
      padding: 0.18rem 0.5rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(148, 163, 184, 0.08);
      color: var(--text);
    }
    .embed {
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.25);
    }
    .embed__frame {
      display: block;
      width: 100%;
      aspect-ratio: 16 / 9;
      height: auto;
      border: 0;
    }
    .primaryCta {
      margin-top: 0.85rem;
    }
    .primaryCta__button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.65rem 1.1rem;
      border-radius: 999px;
      border: 1px solid rgba(79, 70, 229, 0.9);
      background: #4f46e5;
      color: #f9fafb;
      font-weight: 700;
      text-decoration: none;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
    }
    .primaryCta__button:hover {
      background: #6366f1;
      box-shadow: 0 10px 34px rgba(79, 70, 229, 0.5);
    }
    .desc {
      margin: 0;
      color: var(--text);
      max-width: 80ch;
    }
    .resources {
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel);
    }
    .resources__title {
      margin: 0 0 0.75rem 0;
      font-size: 1.05rem;
      letter-spacing: -0.01em;
    }
    .resources__list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.5rem;
    }
    .resources__item {
      margin: 0;
    }
    .resources__link {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      padding: 0.7rem 0.8rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      text-decoration: none;
    }
    .resources__link:hover {
      background: rgba(255, 255, 255, 0.06);
    }
    .resources__label {
      font-weight: 650;
    }
    .resources__type {
      color: var(--muted);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .muted {
      margin: 0;
      color: var(--muted);
    }
    .notfound {
      padding: 1.25rem;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel);
    }
    .notfound__title {
      margin: 0 0 0.4rem 0;
      font-size: 1.4rem;
      letter-spacing: -0.02em;
    }
    .notfound__desc {
      margin: 0 0 0.9rem 0;
      color: var(--muted);
    }
    .notfound__link {
      display: inline-flex;
      padding: 0.55rem 0.8rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(148, 163, 184, 0.1);
      text-decoration: none;
      font-weight: 600;
    }
    .notfound__link:hover {
      background: rgba(148, 163, 184, 0.16);
    }
    .descRich {
      margin-top: 0.5rem;
      padding: 0.75rem 0.5rem 0;
    }
    .descRich__inner {
      max-width: 80ch;
      color: var(--text);
      line-height: 1.7;
      font-size: 0.97rem;
    }
    .descRich__inner p {
      margin: 0 0 0.8rem 0;
    }
    .descRich__inner h2,
    .descRich__inner h3,
    .descRich__inner h4 {
      margin: 1.1rem 0 0.6rem 0;
      letter-spacing: -0.01em;
    }
    .descRich__inner ul,
    .descRich__inner ol {
      padding-left: 1.4rem;
      margin: 0 0 0.8rem 0;
    }
    .descRich__inner li {
      margin: 0.2rem 0;
    }
    .descRich__inner a {
      color: rgba(129, 230, 217, 0.9);
      text-decoration: underline;
    }
    .descRich__inner a:hover {
      color: #a5b4fc;
    }
  </style>
</BaseLayout>

